#!/bin/bash


#
# Radio stations are read from file .radiorc
#
# Each station is on it's own line with format
#   StationName StationURL [Player args]
#
# StationName: station's name (one word only)
# StationURL: station's URL (must be eatable by $PLAYER)
# Player: player capable  handling StationURL
#


self="`basename $0`"
run_in_background=0
show_url=0


# print list of stations and corresponding URLs
stations ()
{
    cat $HOME/.radiorc
}


# from $1, fetch url
get_url ()
{
    echo "`echo $* | awk -- '{print $2}'`"
}


# from $1, fetch url
get_player ()
{
    player=`awk 'BEGIN {for (i=3;i<ARGC;++i) {printf "%s ",ARGV[i]}}' $*`
    echo ${player:-mplayer}
}


# kill previous $PLAYER instances
kill_prev ()
{
    killall -TERM mplayer &>/dev/null
}


# print application usage message
usage ()
{
    cat <<- EOS
Usage:
    $self [options] [station]

options:
    -h | --help         Print this nice helpful message
    -b | --background   Run in background
    -k | --kill         Kill all other $PLAYER instances
    -s | --show         Just show station's corresponding URL

station:
EOS
    stations | awk -- '{print "   ",$1}' | sort

    exit 0
}


# parse params
params=`getopt -o bhks --long background,help,kill,show -n radio -- "$@"`
if [ $? != 0 ]; then
    echo "Try '$self --help' for more information"
    exit 1
fi
eval set -- "$params"


# handle params
while true; do
    case "$1" in
        -b|--background) run_in_background=1 ; shift ;;
        -h|--help) usage ; shift ;;
        -k|--kill) kill_prev ; shift ;;
        -s|--show) show_url=1 ; shift ;;
        --) shift ; break ;;
        *) echo "error..." ; exit 1 ;;
    esac
done


# create list of urls
for station do
    # get station record
    data=`stations | grep -iE "\<$station\>"`

    # get url for station
    url=`get_url $data`
    if [ -z "$url" ]; then
        echo "$self: invalid station"
        echo "Try '$self --help' for more information"
        exit 1
    fi

    # just show if requested
    if [ $show_url == 1 ]; then
        echo "$url"
        continue
    fi

    # get player
    player=`get_player $data`

    # play
    if [ $run_in_background == 1 ]; then
        # if in background, play only first
        nohup $player $url &>/dev/null &
    else
        $player $url
    fi

    exit 0
done
